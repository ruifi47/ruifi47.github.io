<!doctype html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Decrypting Cobalt Strike traffic - Kalmar CTF 2023 lleHSyniT! writeup" /><meta property="og:locale" content="en" /><meta name="description" content="Introduction This writeup presents the intended solution for lleHSniT!, one of the forensics challenges of Kalmar CTF 2023." /><meta property="og:description" content="Introduction This writeup presents the intended solution for lleHSniT!, one of the forensics challenges of Kalmar CTF 2023." /><link rel="canonical" href="/posts/kalmarctf2023_tinyshell/" /><meta property="og:url" content="/posts/kalmarctf2023_tinyshell/" /><meta property="og:site_name" content="ruifi47" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-03-07T18:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Decrypting Cobalt Strike traffic - Kalmar CTF 2023 lleHSyniT! writeup" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-07-14T10:34:45+01:00","datePublished":"2023-03-07T18:00:00+00:00","description":"Introduction This writeup presents the intended solution for lleHSniT!, one of the forensics challenges of Kalmar CTF 2023.","headline":"Decrypting Cobalt Strike traffic - Kalmar CTF 2023 lleHSyniT! writeup","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/kalmarctf2023_tinyshell/"},"url":"/posts/kalmarctf2023_tinyshell/"}</script><title>Decrypting Cobalt Strike traffic - Kalmar CTF 2023 lleHSyniT! writeup | ruifi47</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ruifi47"><meta name="application-name" content="ruifi47"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"><body><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"> <img src="/assets/img/logo.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"> </a><div class="site-title"> <a href="/">ruifi47</a></div><div class="site-subtitle fst-italic">Tech blog</div></div><ul class="nav flex-column flex-grow-1 w-100 ps-0"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <a href="https://github.com/ruifi47" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="javascript:location.href = 'mailto:' + ['ruifi47','protonmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container px-xxl-5"><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100" > <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Decrypting Cobalt Strike traffic - Kalmar CTF 2023 lleHSyniT! writeup</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </span> <span id="search-cancel">Cancel</span></div></div><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pe-xl-4"><div class="post px-1 px-md-2"><h1 data-toc-skip>Decrypting Cobalt Strike traffic - Kalmar CTF 2023 lleHSyniT! writeup</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1678212000" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Mar 7, 2023 </em> </span> <span> Updated <em class="" data-ts="1689327285" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Jul 14, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/ruifi47">ruifi47</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="1331 words" > <em>7 min</em> read</span></div></div></div><div class="post-content"><h2 id="introduction"><span class="me-2"><strong>Introduction</strong></span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>This writeup presents the intended solution for <code class="language-plaintext highlighter-rouge">lleHSniT!</code>, one of the forensics challenges of <a href="https://ctftime.org/event/1878">Kalmar CTF 2023</a>.</p><h2 id="description"><span class="me-2"><strong>Description</strong></span><a href="#description" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><blockquote><p>One of our users here at StupidCorp ran a malicious binary they were sent over an email. We made a process dump, and dumped the network logs. We think it is TinySHell, can you please help figuring out what happened?</p></blockquote><hr /><h2 id="writeup"><span class="me-2"><strong>Writeup</strong></span><a href="#writeup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>To solve this challenge we received 2 files:</p><ul><li><code class="language-plaintext highlighter-rouge">capture.pcap</code>, a pcap network traffic capture;<li><code class="language-plaintext highlighter-rouge">proc.dmp</code>, a process dump file.</ul><p>Let’s start by analyzing the pcap file in <code class="language-plaintext highlighter-rouge">wireshark</code>. After checking the Protocol Hierarchy (Statistics -&gt; Protocol Hierarchy), we can see the several protocols present in the capture. <a href="/assets/img/posts/ctf-writeups/kalmarctf2023/tinyshell/protocol-hierarchy.png" class="popup img-link "><img data-src="/assets/img/posts/ctf-writeups/kalmarctf2023/tinyshell/protocol-hierarchy.png" alt="Protocol hierarchy statistics" class="lazyload" data-proofer-ignore></a> <em>Protocol hierarchy statistics</em> It contains some HTTP packets that might worth taking a closer look. Filtering HTTP packets in <code class="language-plaintext highlighter-rouge">wireshark</code> we can see one GET request made to <code class="language-plaintext highlighter-rouge">/TnHS</code>, some GET requests made to <code class="language-plaintext highlighter-rouge">/g.pixel</code> and some POST requests made to <code class="language-plaintext highlighter-rouge">/submit.php?id=&lt;ID&gt;</code>. <a href="/assets/img/posts/ctf-writeups/kalmarctf2023/tinyshell/requests.png" class="popup img-link "><img data-src="/assets/img/posts/ctf-writeups/kalmarctf2023/tinyshell/requests.png" alt="wireshark traffic after http filter" class="lazyload" data-proofer-ignore></a> <em>Wireshark traffic after http filter</em> <a href="/assets/img/posts/ctf-writeups/kalmarctf2023/tinyshell/http-stream1.png" class="popup img-link "><img data-src="/assets/img/posts/ctf-writeups/kalmarctf2023/tinyshell/http-stream1.png" alt="HTTP stream" class="lazyload" data-proofer-ignore></a> <em>HTTP stream</em> The data in the body of the requests appears to be encrypted. Following the TCP/HTTP stream of one of the HTTP requests, the HOST header set to <code class="language-plaintext highlighter-rouge">Definitely not evil</code> gives us an hint that requests are being sent over to a malicious ‘evil’ server. It seems that some kind of C2 traffic is going on. With the <code class="language-plaintext highlighter-rouge">tshark</code> command:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>tshark <span class="nt">-r</span> capture.pcap <span class="nt">-Y</span> <span class="s1">'http'</span> <span class="nt">-Tfields</span> <span class="nt">-e</span> frame.time <span class="nt">-e</span> http.host
</pre></table></code></div></div><p>it is noticeable the periodicity of the timestamps in the HTTP captured packets as we can see in the tshark output snippet below.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre>...
Feb 23, 2023 07:15:34.007527000 WET     Definitely not evil
Feb 23, 2023 07:15:34.019012000 WET
Feb 23, 2023 07:15:44.022331000 WET     Definitely not evil
Feb 23, 2023 07:15:44.023703000 WET
Feb 23, 2023 07:15:54.037950000 WET     Definitely not evil
Feb 23, 2023 07:15:54.050182000 WET
Feb 23, 2023 07:15:54.052943000 WET     Definitely not evil
Feb 23, 2023 07:15:54.053822000 WET
Feb 23, 2023 07:16:04.057436000 WET     Definitely not evil
Feb 23, 2023 07:16:04.058878000 WET
Feb 23, 2023 07:16:14.064167000 WET     Definitely not evil
Feb 23, 2023 07:16:14.076477000 WET
Feb 23, 2023 07:16:24.084827000 WET     Definitely not evil
Feb 23, 2023 07:16:24.097833000 WET
Feb 23, 2023 07:16:24.100541000 WET     Definitely not evil
Feb 23, 2023 07:16:24.101479000 WET
Feb 23, 2023 07:16:34.106975000 WET     Definitely not evil
Feb 23, 2023 07:16:34.405389000 WET
Feb 23, 2023 07:16:44.421228000 WET     Definitely not evil
Feb 23, 2023 07:16:44.422614000 WET
...
</pre></table></code></div></div><p>By now we have some indicators that some kind of specialized tool is probably being used to compromise the system and the network. A common one actively (ab)used by a wide range of threat actors from ransomware operators to espionage-focused Advanced Persistent Threats is <a href="https://www.cobaltstrike.com/">Cobalt Strike</a> (CS). Cobalt Strike’s default malware payload are called beacons and are used to create a connection to the team server. Active callback sessions from a target are also called beacons.</p><p>The communication between a Cobalt Strike beacon (client) and a Cobalt Strike team server (C2) is encrypted with AES. The AES key is generated by the client beacon and sent to the C2 server using an encrypted metadata blob (by default a cookie). This metadata is encrypted with RSA encryption algorithm where the beacon has the public key of the C2 server and the private key is stored in the C2 server itself.</p><p><a href="/assets/img/posts/ctf-writeups/kalmarctf2023/tinyshell/c2-traffic.png" class="popup img-link shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 600 350'%3E%3C/svg%3E" data-src="/assets/img/posts/ctf-writeups/kalmarctf2023/tinyshell/c2-traffic.png" alt="cobalt strike traffic" width="600" height="350" class="lazyload" data-proofer-ignore></a> <em>Cobalt Strike traffic</em></p><p>So now that we know Cobalt Strike beacons communicate over HTTP and encrypt their data with AES, we need to find a way to extract the keys (AES and HMAC) from the memory dump file <code class="language-plaintext highlighter-rouge">proc.dmp</code> of the cobalt strike beacon. If we can successfully get these cryptographic keys we can decrypt the data. Fortunely, there are tools to make this process easier as we will see in the further analysis.</p><p>Usually in CS traffic it is possible to identify the default malware payload beacon called the <em>stager</em> shellcode which consists of a couple of hundred bytes, and does some basic checks and only then queries the configured C2 for the fully featured backdoor. We can search for signs of this stager shellcode by applying the filter <code class="language-plaintext highlighter-rouge">http.request.uri matches "/....$"</code> in <code class="language-plaintext highlighter-rouge">wireshark</code>.</p><p><a href="/assets/img/posts/ctf-writeups/kalmarctf2023/tinyshell/stager-beacon-packet.png" class="popup img-link "><img data-src="/assets/img/posts/ctf-writeups/kalmarctf2023/tinyshell/stager-beacon-packet.png" alt="Searching for the stager shellcode in wireshark" class="lazyload" data-proofer-ignore></a> <em>Searching for the stager shellcode in wireshark</em></p><p>We get one result, the request made to the endpoint <code class="language-plaintext highlighter-rouge">/TnHS</code> (apparently) is just an endpoint consisted of 4 random alphanumeric characters. However <a href="https://isc.sans.edu/diary/Finding+Metasploit+Cobalt+Strike+URLs/27204">they are not completely random: their 8-bit checksum is a member of a small set of constants</a>.Knowing this, the path <code class="language-plaintext highlighter-rouge">TnHS</code> present in the pcap file can be confirmed that it is a valid path to download a 64-bit full beacon (CS x64) after running the <a href="https://github.com/DidierStevens/Beta/blob/master/metatool.py">metatool</a> (from <a href="https://github.com/DidierStevens/Beta">Didier Stevens Beta Suite</a>) which can be used to analyse suspicious URLs to find relation to exploitation tools such as Cobalt Strike or <a href="https://www.metasploit.com/">Metasploit</a> by calculating the checksum of URLs.</p><p><a href="/assets/img/posts/ctf-writeups/kalmarctf2023/tinyshell/metatool-cs-detection.png" class="popup img-link shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 350'%3E%3C/svg%3E" data-src="/assets/img/posts/ctf-writeups/kalmarctf2023/tinyshell/metatool-cs-detection.png" alt="Checksum calculation using metatool" width="700" height="350" class="lazyload" data-proofer-ignore></a> <em>Checksum calculation with metatool</em></p><p>To start the analysis of the encrypted traffic we start by extracting the beacon download data of the pcap capture file:</p><ol><li>Filter by http traffic;<li>Go to File-&gt;Export Objects-&gt;http;<li>Save packet number 48.</ol><p><a href="/assets/img/posts/ctf-writeups/kalmarctf2023/tinyshell/extract-payload.png" class="popup img-link "><img data-src="/assets/img/posts/ctf-writeups/kalmarctf2023/tinyshell/extract-payload.png" alt="Extract download beacon data" class="lazyload" data-proofer-ignore></a> <em>Extract beacon download data</em></p><p>Using this beacon data and the tool <a href="https://github.com/DidierStevens/DidierStevensSuite/blob/master/1768.py">1768.py</a> we can get some relevant information about the C2 traffic in our capture.</p><p><a href="/assets/img/posts/ctf-writeups/kalmarctf2023/tinyshell/1768-out.png" class="popup img-link "><img data-src="/assets/img/posts/ctf-writeups/kalmarctf2023/tinyshell/1768-out.png" alt="1768.py output" class="lazyload" data-proofer-ignore></a> <em>1768.py output</em></p><p>From the tool <a href="https://github.com/DidierStevens/DidierStevensSuite/blob/master/1768.py">1768.py</a> output above, the beacon communicates with the IP address 192.168.116[.]128 (option 0x0008) on port 80 (option 0x0002). GET requests use path <code class="language-plaintext highlighter-rouge">/g.pixel</code> (option 0x0008), and POST requests use path <code class="language-plaintext highlighter-rouge">/submit.php</code> (option 0x000a) At the bottom we also get info about a guess of the Cobalt Strike version (<code class="language-plaintext highlighter-rouge">4.3</code>). We also get a lot of other information like the payload type (<code class="language-plaintext highlighter-rouge">windows-beacon_http-reverse_http</code>), public key, Host Header, etc. Even knowing that the output didn’t give us a known RSA private key, we have a process memory dump that we can leverage to decrypt the CS traffic using the approach documented in <a href="https://blog.nviso.eu/2021/11/03/cobalt-strike-using-process-memory-to-decrypt-traffic-part-3/">this blog post</a> written by Didier Stevens from NVISO Labs.</p><p>The tool <a href="https://github.com/DidierStevens/DidierStevensSuite/blob/master/cs-extract-key.py">cs-extract-key</a> (also from <a href="https://github.com/DidierStevens/DidierStevensSuite">DidierStevensSuite</a>) looks in the dumped process memory to find valid AES and HMAC keys using different techniques depending on the CS version. An explanation of these techniques can be found <a href="https://github.com/DidierStevens/DidierStevensSuite/blob/master/cs-extract-key.py#L70-L160">here</a>. To efectively use this tool we need a sample of encrypted data of one of the POST requests.</p><p>To grab this data in <code class="language-plaintext highlighter-rouge">wireshark</code> we can apply the filter <code class="language-plaintext highlighter-rouge">http.request.method==POST</code> and get the value in the Data section in the packet details pane or we can use a <code class="language-plaintext highlighter-rouge">tshark</code> command like:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>tshark <span class="nt">-r</span> capture.pcap <span class="nt">-Y</span> <span class="s2">"http.request.method==POST"</span> <span class="nt">-Tfields</span> <span class="nt">-e</span> data
</pre></table></code></div></div><p>to read the capture file, filter POST requests and output their data. Either way, we should be able to get a sample of encrypted data. I chose the following encrypted data sample to work with:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>00000090bc42642121ebc0a784136ca4a86ef41d66fde0358f119ca6c246fac05765288ab7e21c86418f55052815f1da9521ea5f85253b7a657d37857bfbd2cf9f7ddcd16c063d81f1becfb6faef5df286db10b30d020f30c120b30f8f7beae361ddc8cbf5b36063c60ab5218f5cc0b93c089048eacde1dbbca3877a1b093dd076370de61250f922c396cdf4fcda4c6409a53971
</pre></table></code></div></div><p>With this data we can now run the tool and extract the cryptographic keys from the Cobalt Strike beacon process dump with:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>./cs-extract-key.py <span class="nt">-c</span> &lt;ENCRYPTED_DATA&gt; proc.dmp
</pre></table></code></div></div><p><a href="/assets/img/posts/ctf-writeups/kalmarctf2023/tinyshell/cs-extract-key-output.png" class="popup img-link "><img data-src="/assets/img/posts/ctf-writeups/kalmarctf2023/tinyshell/cs-extract-key-output.png" alt="cs-extract-key.py output" class="lazyload" data-proofer-ignore></a> <em>cs-extract-key.py output</em></p><p>From the output above, we get the HMAC key <code class="language-plaintext highlighter-rouge">24a0f5e701439f460d52ef4810f592f3</code> and the AES key <code class="language-plaintext highlighter-rouge">3c4267894c6fee7a5aaa4d13e0289051</code>. Now it is possible to easily decrypt the traffic with the help of the tool <a href="https://github.com/DidierStevens/DidierStevensSuite/blob/master/cs-parse-traffic.py">cs parse traffic</a>, also from <a href="https://github.com/DidierStevens/DidierStevensSuite">DidierStevensSuite</a>. The extracted keys must be specified after the flag <code class="language-plaintext highlighter-rouge">-k</code> in the format <code class="language-plaintext highlighter-rouge">HMACkey:AESkey</code> resulting in the command:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>./cs-parse-traffic.py <span class="nt">--extract</span> capture.pcap <span class="nt">-k</span> 24a0f5e701439f460d52ef4810f592f3:3c4267894c6fee7a5aaa4d13e0289051
</pre></table></code></div></div><p>After the tool finishes running, we get some <code class="language-plaintext highlighter-rouge">.vir</code> files. Analyzing the <a href="https://github.com/DidierStevens/DidierStevensSuite/blob/master/cs-parse-traffic.py">cs parse traffic</a> terminal output, packet number <code class="language-plaintext highlighter-rouge">1983</code> contains the POST request with the data of the file <code class="language-plaintext highlighter-rouge">password.txt</code> that was downloaded from the victim computer (image below).</p><p><a href="/assets/img/posts/ctf-writeups/kalmarctf2023/tinyshell/out-cs-parse-traffic.png" class="popup img-link shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 700 300'%3E%3C/svg%3E" data-src="/assets/img/posts/ctf-writeups/kalmarctf2023/tinyshell/out-cs-parse-traffic.png" alt="cs-parse-traffic output" width="700" height="300" class="lazyload" data-proofer-ignore></a> <em>cs-parse-traffic output</em></p><p>The data of the file <code class="language-plaintext highlighter-rouge">password.txt</code> was saved in our directory with the md5 hash value of <code class="language-plaintext highlighter-rouge">61ca2f3dc9212781c983f9e13a99be08</code> in the file name. Let’s run <code class="language-plaintext highlighter-rouge">cat</code> to see the contents of this file.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cat </span>payload-61ca2f3dc9212781c983f9e13a99be08.vir
DO NOT READ!!!
PRIVATE INFORMATION!!!
...
STOP READING!!!!
...
AYY I TOLD YOU NOT TO READ
...
</pre></table></code></div></div><p><a href="/assets/img/posts/ctf-writeups/kalmarctf2023/tinyshell/flag.png" class="popup img-link "><img data-src="/assets/img/posts/ctf-writeups/kalmarctf2023/tinyshell/flag.png" alt="flag" class="lazyload" data-proofer-ignore></a> <em>Finding the flag at the end of the file</em></p><p>At the end of the file is the password <code class="language-plaintext highlighter-rouge">kalmar{My_F4v0r1t3_G4m3_1s_Cobalt_Strike:gL0b4l_0p3r4t0rs}</code> which is the flag needed to solve the challenge.</p><hr /><h2 id="references"><span class="me-2"><strong>References</strong></span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><a href="https://www.mandiant.com/resources/blog/defining-cobalt-strike-components">https://www.mandiant.com/resources/blog/defining-cobalt-strike-components</a><li><a href="https://blog.nviso.eu/2021/10/21/cobalt-strike-using-known-private-keys-to-decrypt-traffic-part-1/">https://blog.nviso.eu/2021/10/21/cobalt-strike-using-known-private-keys-to-decrypt-traffic-part-1/</a><li><a href="https://blog.nviso.eu/2021/10/27/cobalt-strike-using-known-private-keys-to-decrypt-traffic-part-2/">https://blog.nviso.eu/2021/10/27/cobalt-strike-using-known-private-keys-to-decrypt-traffic-part-2/</a><li><a href="https://blog.nviso.eu/2021/11/03/cobalt-strike-using-process-memory-to-decrypt-traffic-part-3/">https://blog.nviso.eu/2021/11/03/cobalt-strike-using-process-memory-to-decrypt-traffic-part-3/</a><li><a href="https://blog.didierstevens.com/2021/04/26/quickpost-decrypting-cobalt-strike-traffic/">https://blog.didierstevens.com/2021/04/26/quickpost-decrypting-cobalt-strike-traffic/</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href='/categories/ctf-writeups/'>CTF writeups</a>, <a href='/categories/kalmar-ctf-2023/'>Kalmar CTF 2023</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/ctf-writeups/" class="post-tag no-text-decoration" >ctf-writeups</a> <a href="/tags/kalmarctf2023/" class="post-tag no-text-decoration" >kalmarCTF2023</a> <a href="/tags/forensics/" class="post-tag no-text-decoration" >forensics</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted me-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Decrypting%20Cobalt%20Strike%20traffic%20-%20Kalmar%20CTF%202023%20lleHSyniT!%20writeup%20-%20ruifi47&url=%2Fposts%2Fkalmarctf2023_tinyshell%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter" > <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Decrypting%20Cobalt%20Strike%20traffic%20-%20Kalmar%20CTF%202023%20lleHSyniT!%20writeup%20-%20ruifi47&u=%2Fposts%2Fkalmarctf2023_tinyshell%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook" > <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Fkalmarctf2023_tinyshell%2F&text=Decrypting%20Cobalt%20Strike%20traffic%20-%20Kalmar%20CTF%202023%20lleHSyniT!%20writeup%20-%20ruifi47" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram" > <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/htbca2022_puppeteer/">HTB Cyber Apocalypse CTF 2022 - Forensics - Puppeteer writeup</a><li class="text-truncate lh-lg"> <a href="/posts/kalmarctf2023_tinyshell/">Decrypting Cobalt Strike traffic - Kalmar CTF 2023 lleHSyniT! writeup</a><li class="text-truncate lh-lg"> <a href="/posts/htbca2022_reversing/">HTB Cyber Apocalypse CTF 2022 - Reversing - WIDE, Rebuilding, Without a Trace & Teleport writeups</a><li class="text-truncate lh-lg"> <a href="/posts/typhoonconctf2022_hidden_character/">TyphoonCon CTF 2022 - Web - Hidden Character writeup</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ctf-writeups/">ctf-writeups</a> <a class="post-tag btn btn-outline-primary" href="/tags/forensics/">forensics</a> <a class="post-tag btn btn-outline-primary" href="/tags/hackthebox/">HackTheBox</a> <a class="post-tag btn btn-outline-primary" href="/tags/htbca2022/">HTBca2022</a> <a class="post-tag btn btn-outline-primary" href="/tags/backdoor/">backdoor</a> <a class="post-tag btn btn-outline-primary" href="/tags/javascript/">javascript</a> <a class="post-tag btn btn-outline-primary" href="/tags/kalmarctf2023/">kalmarCTF2023</a> <a class="post-tag btn btn-outline-primary" href="/tags/reverse-engineering/">reverse-engineering</a> <a class="post-tag btn btn-outline-primary" href="/tags/sqli/">sqli</a> <a class="post-tag btn btn-outline-primary" href="/tags/typhoonconctf2022/">TyphoonConCTF2022</a></div></div></div><div id="toc-wrapper" class="ps-0 pe-4 mb-5"><div class="panel-heading ps-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-3 pe-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ms-1" data-toc-skip> Further Reading</h3><div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><div class="col"> <a href="/posts/htbca2022_puppeteer/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1653170400" data-df="ll" > May 21, 2022 </em><h4 class="pt-0 my-2" data-toc-skip>HTB Cyber Apocalypse CTF 2022 - Forensics - Puppeteer writeup</h4><div class="text-muted small"><p> Puppeteer Challenge Info Planet Longhir is known for it’s top-tier researchers. Due to their dedication in science and engineering, their military equipment is the most advanced one in the gal...</p></div></div></a></div><div class="col"> <a href="/posts/htbca2022_reversing/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1653238800" data-df="ll" > May 22, 2022 </em><h4 class="pt-0 my-2" data-toc-skip>HTB Cyber Apocalypse CTF 2022 - Reversing - WIDE, Rebuilding, Without a Trace & Teleport writeups</h4><div class="text-muted small"><p> WIDE Challenge Info We’ve received reports that Draeger has stashed a huge arsenal in the pocket dimension Flaggle Alpha. You’ve managed to smuggle a discarded access terminal to the Widely In...</p></div></div></a></div><div class="col"> <a href="/posts/typhoonconctf2022_hidden_character/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1656176400" data-df="ll" > Jun 25, 2022 </em><h4 class="pt-0 my-2" data-toc-skip>TyphoonCon CTF 2022 - Web - Hidden Character writeup</h4><div class="text-muted small"><p> Hidden Character Challenge Description It takes one character [ ] to show you the path to salvation. And it takes a hidden character to lead you to the flag Let’s start by accessing the webs...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/typhoonconctf2022_hidden_character/" class="btn btn-outline-primary" prompt="Older" ><p>TyphoonCon CTF 2022 - Web - Hidden Character writeup</p></a><div class="btn btn-outline-primary disabled" prompt="Newer" ><p>-</p></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ctf-writeups/">ctf-writeups</a> <a class="post-tag btn btn-outline-primary" href="/tags/forensics/">forensics</a> <a class="post-tag btn btn-outline-primary" href="/tags/hackthebox/">HackTheBox</a> <a class="post-tag btn btn-outline-primary" href="/tags/htbca2022/">HTBca2022</a> <a class="post-tag btn btn-outline-primary" href="/tags/backdoor/">backdoor</a> <a class="post-tag btn btn-outline-primary" href="/tags/javascript/">javascript</a> <a class="post-tag btn btn-outline-primary" href="/tags/kalmarctf2023/">kalmarCTF2023</a> <a class="post-tag btn btn-outline-primary" href="/tags/reverse-engineering/">reverse-engineering</a> <a class="post-tag btn btn-outline-primary" href="/tags/sqli/">sqli</a> <a class="post-tag btn btn-outline-primary" href="/tags/typhoonconctf2022/">TyphoonConCTF2022</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div></div><footer><div class="container px-lg-4"><div class="d-flex justify-content-center align-items-center text-muted mx-md-3"><p>Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p><p>© 2023 <a href="https://github.com/ruifi47">ruifi47</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p></div></div></footer><div id="mask"></div><button id="back-to-top" aria-label="back-to-top" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.0/dist/jquery.min.js,npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.7/dayjs.min.js,npm/dayjs@1.11.7/locale/en.min.js,npm/dayjs@1.11.7/plugin/relativeTime.min.js,npm/dayjs@1.11.7/plugin/localizedFormat.min.js,npm/tocbot@4.21.0/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="px-1 px-sm-2 px-lg-4 px-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
